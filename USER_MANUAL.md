# Radar-Camera Fusion Calibration System ç”¨æˆ·æ‰‹å†Œ

## ğŸ“– ç®€ä»‹
æœ¬ç³»ç»Ÿç”¨äºè¾…åŠ©é›·è¾¾ä¸ç›¸æœºçš„è”åˆæ ‡å®šã€‚é€šè¿‡åœ¨é›·è¾¾é¸Ÿç°å›¾ï¼ˆBEVï¼‰å’Œç›¸æœºå›¾åƒä¸Šé€‰å–å¯¹åº”çš„ç‰¹å¾ç‚¹ï¼Œæˆ–è€…è°ƒæ•´å‡ ä½•å‚æ•°ï¼Œæ¥å®ç°ä¸¤è€…åæ ‡ç³»çš„å¯¹é½ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ç¨‹åº
è¿è¡Œ `python3 main.py` å¯åŠ¨åº”ç”¨ç¨‹åºã€‚

### 2. åŠ è½½æ•°æ®
1. ç‚¹å‡»é¡¶éƒ¨ **"ğŸ“‚ Sync JSON"** æŒ‰é’®ã€‚
2. é€‰æ‹©åŒ…å«åŒæ­¥æ•°æ®çš„ JSON æ–‡ä»¶ï¼ˆä¾‹å¦‚ `samples/sync_000.json`ï¼‰ã€‚
3. ç¨‹åºå°†è‡ªåŠ¨åŠ è½½å¯¹åº”çš„å›¾åƒå’Œé›·è¾¾ç‚¹äº‘æ•°æ®ã€‚
4. ç‚¹å‡»é¡¶éƒ¨ **"Batch < >"** æŒ‰é’®åˆ‡æ¢ä¸åŒçš„æ•°æ®å¸§ã€‚

### 3. æ ¡å‡†æµç¨‹ (ä¸¤ç§æ¨¡å¼)

#### æ¨¡å¼ A: åŸºäºæ–‡ä»¶/ç‚¹å¯¹çš„æ ¡å‡† (Homography)
1. ç‚¹å‡»å³ä¾§é¢æ¿çš„ **"Wait Coarse"** æŒ‰é’®ï¼ˆæˆ– **"Coarse TXT"** è‹¥å·²åŠ è½½ï¼‰ã€‚
2. é€‰æ‹©ä¸€ä¸ªç°æœ‰çš„ç²—æ ¡å‡† TXT æ–‡ä»¶ï¼ˆåŒ…å« Homography çŸ©é˜µï¼‰ã€‚
3. å›¾åƒä¸Šå°†æ˜¾ç¤ºåŸºäºè¯¥æ–‡ä»¶çš„é›·è¾¾æŠ•å½±ç‚¹ï¼ˆç»¿è‰²ï¼‰ã€‚
4. **éªŒè¯**: è§‚å¯Ÿç»¿è‰²ç‚¹æ˜¯å¦ä¸å›¾åƒä¸­çš„ç›®æ ‡å¯¹é½ã€‚

#### æ¨¡å¼ B: å‡ ä½•å‚æ•°æ‰‹åŠ¨å¾®è°ƒ (Geometric Tuning)
1. åœ¨å³ä¾§ **"Geometric Parameters"** é¢æ¿ä¸­ã€‚
2. å³ä½¿æ²¡æœ‰æ ¡å‡†æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒæ•´æ»‘å—ï¼š
   - **Camera H**: ç›¸æœºå®‰è£…é«˜åº¦ï¼ˆç±³ï¼‰ã€‚
   - **Pitch**: ç›¸æœºä¿¯ä»°è§’ï¼ˆå¼§åº¦ï¼‰ã€‚
   - **Radar X/Y**: é›·è¾¾ç›¸å¯¹äºåè½´çš„å®‰è£…åç§»é‡ã€‚
   - **Radar Yaw**: é›·è¾¾åèˆªè§’ã€‚
3. **å®æ—¶åé¦ˆ**: è°ƒæ•´æ»‘å—æ—¶ï¼Œå›¾åƒä¸Šçš„é›·è¾¾æŠ•å½±ç‚¹ï¼ˆç»¿è‰²ï¼‰ä¼šå®æ—¶ç§»åŠ¨ã€‚è¿™æ˜¯åŸºäºä¸¥è°¨çš„å‡ ä½•æŠ•å½±æ¨¡å‹è®¡ç®—çš„ã€‚

### 4. æ ‡æ³¨ä¸è®¡ç®—

#### é€‰å–ç‚¹å¯¹ (Point Pairs)
1. åœ¨å³ä¾§é€‰æ‹© **"Select Pair"** å•é€‰æ¡†ã€‚
2. **ç¬¬ä¸€æ­¥**: åœ¨ **BEV (å³ä¸‹)** è§†å›¾ä¸­ç‚¹å‡»ä¸€ä¸ªé›·è¾¾ç‚¹ï¼ˆçº¢è‰²ï¼‰ã€‚è¯¥ç‚¹ä¼šå˜é»„ï¼ˆPendingï¼‰ã€‚
3. **ç¬¬äºŒæ­¥**: åœ¨ **Image (å·¦å¤§)** è§†å›¾ä¸­ç‚¹å‡»å¯¹åº”çš„å›¾åƒä½ç½®ã€‚
4. ç³»ç»Ÿä¼šè®°å½•è¿™ä¸€å¯¹ç‚¹ï¼Œå¹¶åœ¨BEVä¸Šæ˜¾ç¤ºç›¸åº”çš„åœ†ç¯æ ‡è®°ã€‚
5. é‡å¤æ­¤è¿‡ç¨‹ï¼Œè‡³å°‘é€‰å– 4 å¯¹ç‚¹ã€‚

#### ç»˜åˆ¶è½¦é“çº¿ (Lane Drawing) (ç”¨äºè®¡ç®—Pitch)
1. åœ¨å³ä¾§é€‰æ‹© **"Lane Draw"** å•é€‰æ¡†ã€‚
2. åœ¨å›¾åƒä¸Šç‚¹å‡»ä¸¤ç‚¹ä»¥ç»˜åˆ¶ä¸€æ¡å‚è€ƒçº¿ï¼ˆé€šå¸¸æ˜¯è½¦é“çº¿ï¼‰ã€‚
3. ç»˜åˆ¶è‡³å°‘ä¸¤æ¡**å¹³è¡Œ**çš„çº¿ï¼ˆä¾‹å¦‚å·¦è½¦é“çº¿å’Œå³è½¦é“çº¿ï¼‰ã€‚
4. ç‚¹å‡» **"ğŸ“ Compute Pitch"**ã€‚
5. ç³»ç»Ÿå°†è®¡ç®—ç›¸æœºçš„ä¿¯ä»°è§’ï¼Œå¹¶è‡ªåŠ¨æ›´æ–° **Pitch** æ»‘å—ã€‚

#### Pitch è‡ªåŠ¨ä¼˜åŒ– (Optimize Pitch) âœ¨
1. **åŸç†**: ç³»ç»Ÿè¯»å– `dataset` ç›®å½•ä¸‹æ‰€æœ‰å·²ä¿å­˜çš„ç‚¹å¯¹æ–‡ä»¶ (`point_pairs_*.txt`)ã€‚
2. **æ“ä½œ**: ç‚¹å‡»é¡¶éƒ¨æ“ä½œæ çš„ **"âœ¨ Optimize"** æŒ‰é’®ã€‚
3. **æ•ˆæœ**: ç®—æ³•ä¼šåœ¨å½“å‰ Pitch é™„è¿‘è¿›è¡Œå…¨å±€æœç´¢ï¼Œæ‰¾åˆ°ä¸€ä¸ªä½¿æ‰€æœ‰ç‚¹å¯¹çš„æŠ•å½±è¯¯å·®æœ€å°çš„æœ€ä½³ Pitch å€¼ï¼Œå¹¶è‡ªåŠ¨åˆ·æ–°è§†å›¾ï¼ˆBEVåŠå›¾åƒæŠ•å½±ï¼‰ã€‚
4. **é€‚ç”¨åœºæ™¯**: å½“æ‚¨åœ¨å¤šä¸ªBatchä¸­ç§¯ç´¯äº†å¤§é‡ç‚¹å¯¹åï¼Œä½¿ç”¨æ­¤åŠŸèƒ½å¯è·å¾—å…¨å±€æœ€ä¼˜è§£ã€‚

### 5. ä¿å­˜ç»“æœ

*   **Export JSON**: ç‚¹å‡»é¡¶éƒ¨ **"ğŸ’¾ Export JSON"** å°†å½“å‰çš„æ ‡æ³¨ï¼ˆç‚¹å¯¹ã€è½¦é“çº¿ï¼‰å¯¼å‡ºä¸ºæ•°æ®æ–‡ä»¶ã€‚
*   **Save Params (JSON)**: ç‚¹å‡» **"ğŸ“„ JSON"** æŒ‰é’®ã€‚
    *   **å†…å®¹**: ä¿å­˜å½“å‰çš„ ç›¸æœºå†…å‚ (Camera Intrinsics)ã€å¤–å‚ (Extrinsics)ã€é›·è¾¾åç§» (Radar Offsets) ä»¥åŠ **å˜æ¢çŸ©é˜µ (Homography Matrices)**ã€‚
    *   **çŸ©é˜µè¯´æ˜**:
        *   `radar_to_bev`: é›·è¾¾åæ ‡åˆ°BEVçš„å˜æ¢çŸ©é˜µ (3x3)ã€‚
        *   `camera_to_bev`: å›¾åƒåƒç´ åˆ°BEVå¹³é¢çš„å•åº”æ€§çŸ©é˜µ (3x3, Homography)ã€‚æ­¤çŸ©é˜µå¯ç›´æ¥ç”¨äºå°†å›¾åƒåƒç´ æ˜ å°„åˆ°BEVç©ºé—´ã€‚

---

## ğŸ–¥ ç•Œé¢è¯´æ˜

### ä¸»è§†å›¾ (å·¦ä¾§)
*   **æ˜¾ç¤º**: ç›¸æœºå›¾åƒã€‚
*   **äº¤äº’**:
    *   **å·¦é”®ç‚¹å‡»**: æ ¹æ®å½“å‰æ¨¡å¼ï¼ˆé€‰ç‚¹æˆ–ç”»çº¿ï¼‰è¿›è¡Œæ“ä½œã€‚
    *   **ç»¿è‰²ç‚¹**: é›·è¾¾ç›®æ ‡çš„æŠ•å½±ä½ç½®ã€‚
    *   **é»„è‰²åœˆ**: é¼ æ ‡æ‚¬åœé¢„è§ˆã€‚

### BEV è§†å›¾ (å³ä¸‹)
*   **æ˜¾ç¤º**: é›·è¾¾ç‚¹äº‘çš„é¸Ÿç°å›¾ã€‚
    *   **çº¢è‰²ç‚¹**: åŸå§‹é›·è¾¾ç›®æ ‡ã€‚
    *   **å½©è‰²ç¯**: å·²æ ‡æ³¨çš„ç‚¹å¯¹ã€‚
    *   **ç™½è‰²è™šçº¿**: (æ ¡å‡†å) å›¾åƒé€‰ç‚¹åæŠ•å½±å›BEVçš„ä½ç½®ï¼Œç”¨äºå¯¹æ¯”è¯¯å·®ã€‚
*   **åæ ‡ç³»**: è½¦è¾†åæ ‡ç³»ï¼ˆYå‘å‰ï¼ŒXå‘å³ï¼‰ã€‚èŒƒå›´ï¼šçºµå‘ 0-160mï¼Œæ¨ªå‘ Â±20mã€‚

### æ§åˆ¶é¢æ¿ (å³ä¾§)
*   **Batch**: åˆ‡æ¢æ•°æ®å¸§ã€‚
*   **Edit Modes**: åˆ‡æ¢â€œé€‰ç‚¹â€æˆ–â€œç”»çº¿â€æ¨¡å¼ã€‚
*   **Geometric Parameters**: æ‰‹åŠ¨è°ƒæ•´ç›¸æœºå’Œé›·è¾¾çš„å¤–å‚ã€‚
*   **Calibration**: åŠ è½½/ä¿å­˜æ ¡å‡†æ–‡ä»¶ï¼Œè®¡ç®— Pitchã€‚

## â“ å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆå›¾åƒä¸Šæ²¡æœ‰æ˜¾ç¤ºé›·è¾¾ç‚¹ï¼Ÿ**
A: è¯·ç¡®ä¿æ‚¨å·²ç»åŠ è½½äº† **Coarse TXT** æ ¡å‡†æ–‡ä»¶ã€‚ä¸ºäº†ç•Œé¢æ•´æ´ï¼ŒæœªåŠ è½½æ ¡å‡†æ–‡ä»¶æ—¶ä¸æ˜¾ç¤ºæŠ•å½±ã€‚

**Q: ä¸ºä»€ä¹ˆæŠ•å½±çš„ç‚¹ä½ç½®ä¸å¯¹ï¼Ÿ**
A:
1. æ£€æŸ¥ **Camera H** (é«˜åº¦) æ˜¯å¦æ­£ç¡®ã€‚
2. æ£€æŸ¥ **Radar Yaw** (åèˆªè§’) æ˜¯å¦æ­£ç¡®ã€‚
3. å¦‚æœä½¿ç”¨å‡ ä½•æ¨¡å¼ï¼Œè¯·å°è¯•å¾®è°ƒ **Pitch**ã€‚

**Q: ä¸ºä»€ä¹ˆæŒ‰äº† "Compute Pitch" æ²¡ååº”ï¼Ÿ**
A: è¯·ç¡®ä¿æ‚¨åœ¨å›¾åƒä¸Šè‡³å°‘ç”»äº†ä¸¤æ¡**å¹³è¡Œ**çš„çº¿ï¼ˆä¾‹å¦‚é“è·¯ä¸¤ä¾§çš„ç›´çº¿ï¼‰ï¼Œç³»ç»Ÿåˆ©ç”¨æ¶ˆå¤±ç‚¹åŸç†è®¡ç®—ä¿¯ä»°è§’ã€‚

---

## ğŸ›  å¼€å‘è€…æŒ‡å—ï¼šæ ¸å¿ƒå˜æ¢å‡½æ•°ä¸å‚æ•°

è‹¥éœ€ä¿®æ”¹æŠ•å½±ç®—æ³•æˆ–é€‚é…æ–°è½¦å‹å‚æ•°ï¼Œè¯·å…³æ³¨ `calibration.py` ä¸­çš„ `CoordinateTransformer` ç±»ã€‚

### 1. å›¾åƒè½¬ BEV (Image to BEV)
æ­¤å‡½æ•°å°†å›¾åƒä¸Šçš„åƒç´ åæ ‡åæŠ•å½±åˆ°è½¦è¾† BEV å¹³é¢ä¸Šï¼ˆåŸºäºåœ°é¢å¹³å¦å‡è®¾ï¼‰ã€‚

*   **å‡½æ•°å**: `image_to_bev(self, u, v)`
*   **è¾“å…¥**:
    *   `u, v`: å›¾åƒåƒç´ åæ ‡ã€‚
*   **å…³é”®å‚æ•° (CameraParams)**:
    *   `cx, cy`: ä¸»ç‚¹åæ ‡ï¼ˆå…‰å¿ƒï¼‰ã€‚
    *   `fx, fy`: ç„¦è·ã€‚
    *   `height`: ç›¸æœºå®‰è£…é«˜åº¦ (Camera Z in Vehicle Frame)ã€‚**ä¿®æ”¹æ­¤å€¼ç›´æ¥æ”¹å˜æŠ•å½±è·ç¦»çš„æ¯”ä¾‹**ã€‚
    *   `pitch`: ç›¸æœºä¿¯ä»°è§’ã€‚**ä¿®æ”¹æ­¤å€¼ä¼šæ”¹å˜åœ°å¹³çº¿ä½ç½®å’Œè¿œå¤„ç‚¹çš„æŠ•å½±è·ç¦»**ã€‚
*   **ä»£ç ä½ç½®**: `calibration.py` Line ~235

### 2. é›·è¾¾è½¬ BEV (Radar to BEV)
æ­¤å‡½æ•°å°†åŸå§‹é›·è¾¾æ•°æ®è½¬æ¢ä¸ºè½¦è¾†ç»Ÿä¸€åæ ‡ç³»ã€‚

*   **å‡½æ•°å**: `radar_to_bev(self, x_radar, y_radar)`
*   **è¾“å…¥**:
    *   `x_radar, y_radar`: åŸå§‹é›·è¾¾åæ ‡ï¼ˆé€šå¸¸ x=å‰, y=å·¦ï¼‰ã€‚
*   **å…³é”®å‚æ•° (RadarParams)**:
    *   `yaw`: é›·è¾¾åèˆªè§’ã€‚ç”¨äºæ—‹è½¬é›·è¾¾åŸå§‹åæ ‡ç³»ã€‚
    *   `x_offset`: é›·è¾¾åœ¨è½¦è¾†çºµå‘çš„å®‰è£…ä½ç½® (Forward)ã€‚
    *   `y_offset`: é›·è¾¾åœ¨è½¦è¾†æ¨ªå‘çš„å®‰è£…ä½ç½® (Lateral)ã€‚
*   **ä»£ç ä½ç½®**: `calibration.py` Line ~183

### 3. é›·è¾¾è½¬å›¾åƒ (Radar to Image)
è¿™æ˜¯æœ€å¸¸ç”¨çš„æŠ•å½±åŠŸèƒ½ï¼Œç”¨äºå°†é›·è¾¾ç‚¹æ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸Šã€‚å®ƒæ˜¯ä¸€ä¸ªç»„åˆè¿‡ç¨‹ã€‚

*   **æµç¨‹**: `Radar Raw` -> (`radar_to_bev`) -> `BEV` -> (`bev_to_image`) -> `Image Pixel`
*   **å‡½æ•°å**: `bev_to_image(self, x_bev, y_bev)`
*   **å…³é”®å‚æ•°**:
    *   åŒæ—¶ä¾èµ– **Radarå‚æ•°** (å†³å®šBEVä½ç½®) å’Œ **Cameraå‚æ•°** (å†³å®šæŠ•å½±åƒç´ )ã€‚
    *   è‹¥å‘ç°æŠ•å½±ç‚¹ **å·¦å³åç§»**ï¼šä¼˜å…ˆæ£€æŸ¥ Radar `yaw` æˆ– Camera `x_offset` (é€šå¸¸ä¸º0)ã€‚
    *   è‹¥å‘ç°æŠ•å½±ç‚¹ **ä¸Šä¸‹åç§»**ï¼šä¼˜å…ˆæ£€æŸ¥ Camera `pitch` æˆ– `height`ã€‚
*   **ä»£ç ä½ç½®**: `calibration.py` Line ~284

### 4. åæ ‡ç³»å®šä¹‰é€ŸæŸ¥
*   **Vehicle (BEV)**:
    *   **Yè½´**: å‰è¿›æ–¹å‘ (Forward), 0-160mã€‚
    *   **Xè½´**: å³ä¾§æ–¹å‘ (Right), Â±20mã€‚
    *   **Zè½´**: å‚ç›´å‘ä¸Š (Up)ã€‚
*   **Camera Frame (Before Rotation)**:
    *   X=Right, Y=Down, Z=Forward.
*   **Radar Raw Frame**:
    *   X=Forward, Y=Left. (åœ¨ `radar_to_bev` ä¸­ä¼šè¢«è½¬æ¢)

### 5. åŸºäºç‚¹å¯¹çš„å•åº”æ€§çŸ©é˜µè®¡ç®— (Homography Computation)
æ­¤éƒ¨åˆ†å¯¹åº” **æ¨¡å¼ A (Coarse TXT/Homography)**ï¼Œå³ä¸ä¾èµ–å¤æ‚çš„å‡ ä½•å‚æ•°ï¼Œç›´æ¥é€šè¿‡ç‚¹å¯¹æ±‚è§£æŠ•å½±çŸ©é˜µã€‚

*   **åŠŸèƒ½**: è®¡ç®—ä» **Radarå¹³é¢** åˆ° **Imageå¹³é¢** çš„ 2D-2D æŠ•å½±çŸ©é˜µã€‚
*   **è¾“å…¥**:
    *   ä¸€ç»„å¯¹åº”çš„ç‚¹å¯¹ $(x_r, y_r)$ å’Œ $(u, v)$ã€‚
    *   è‡³å°‘éœ€è¦ **4å¯¹** ç‚¹ã€‚
*   **å‡½æ•°**: `_compute_homography(points)` (åœ¨ `backend.py`)
*   **æ•°å­¦åŸç† (Formula)**:
    ä½¿ç”¨å•åº”æ€§çŸ©é˜µ (Homography Matrix) **H** (3x3) æè¿°å˜æ¢ã€‚
    
    $$
    s \begin{bmatrix} u \\ v \\ 1 \end{bmatrix} = \mathbf{H} \begin{bmatrix} x_r \\ y_r \\ 1 \end{bmatrix} = 
    \begin{bmatrix} h_{00} & h_{01} & h_{02} \\ h_{10} & h_{11} & h_{12} \\ h_{20} & h_{21} & h_{22} \end{bmatrix} 
    \begin{bmatrix} x_r \\ y_r \\ 1 \end{bmatrix}
    $$
    
    æœ€ç»ˆåƒç´ åæ ‡é€šè¿‡é½æ¬¡åæ ‡å½’ä¸€åŒ–å¾—åˆ°ï¼š
    
    $$ u = \frac{h_{00}x_r + h_{01}y_r + h_{02}}{h_{20}x_r + h_{21}y_r + h_{22}} $$
    $$ v = \frac{h_{10}x_r + h_{11}y_r + h_{12}}{h_{20}x_r + h_{21}y_r + h_{22}} $$

*   **å·¥ç¨‹å®ç°**:
    *   ä»£ç ä½¿ç”¨ `cv2.findHomography(src_points, dst_points)`ã€‚
    *   é€šå¸¸é‡‡ç”¨ **RANSAC (Random Sample Consensus)** ç®—æ³•æ¥å‰”é™¤è¯¯åŒ¹é…ç‚¹ï¼ˆOutliersï¼‰ï¼Œæé«˜çŸ©é˜µçš„é²æ£’æ€§ã€‚
